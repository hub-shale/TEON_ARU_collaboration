---
title: "ARU Analysis"
output: html_document
date: "2025-09-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r Libraries}
# import libraries
library(tidyverse)
library(ggplot2)
library(vegan)
library(gitcreds)
```

```{r DataLoad}
# data load
PCdata_raw <- read.csv("data_raw/PointCountresults.csv")
ARUdata_raw <- read.csv("data_raw/ARUXHumanresults.csv")
BRDdata_raw <- read.csv("data_raw/Birdnetresults.csv")

# Save as rds
saveRDS(PCdata_raw, "data/PC_data.rds")
saveRDS(ARUdata_raw, "data/ARUxHuman_data.rds")
saveRDS(BRDdata_raw, "data/BirdNet_data.rds")

# Load rds
PC_data <- readRDS("data/PC_data.rds")
ARUxHuman_data <- readRDS("data/ARUxHuman_data.rds")
BirdNet_data <- readRDS("data/BirdNet_data.rds")

```


```{r Wrangling}

#Clean up Point Counts
clean_PC_data <- PC_data |>
  janitor::clean_names() |>
  mutate(
    date = as.Date(date),
    presence = 1,
    method = "Point Count",
  ) |>
  select(site, date, start_time, species_code, presence, method, aru_match)


#Clean up ARU with Human Listener
clean_ARUxHuman_data = ARUxHuman_data |>
  janitor::clean_names() |>
  mutate(
    # make sure date is Date class
    date = as.Date(date, format = "%m/%d/%Y"),
    presence = 1,
    method = "ARUxHuman",
  ) |>
  select(site, date, start_time, species_code, presence, method, pc_match)


#Clean up BirdNet Results
clean_BirdNet_data = BirdNet_data |>
  janitor::clean_names() |>
  mutate(
    # make sure date is Date class
    date = as.Date(date, format = "%m/%d/%Y"),
    presence = 1,
    method = "ARUxBirdNet",
  ) |>
  select(site, date, start_time, common_name, species_code, presence, confidence, method, aru_match)


#Combine into one dataframe
all_obs <- bind_rows(
  clean_PC_data,
  clean_ARUxHuman_data,
  clean_BirdNet_data
)

#Reorder columns to a nicer order
all_obs <- all_obs |>
  select(
    site,
    date,
    start_time,
    common_name,
    species_code,
    presence,
    confidence,
    method,
    pc_match,
    aru_match,
  )

```


## Matching Point Count and ARU Recording Comparisons
```{r Create Matching Dataset}

##Creating subset of observations with matching Point Count, ARUxHuman, and Birdnet files. Convoluted code because of the variability in start times for Point Counts especially for aquatic sites.
#Convert start time to minutes to avoid errors when matching later
aru_anchors <- clean_ARUxHuman_data %>%
  mutate(
    start_dt  = hm(start_time),
    start_min = hour(start_dt)*60 + minute(start_dt),
    # define event_id for each unique "counting event"
    event_id  = paste(site, date, start_min, sep = "_")
  )

#filter to only rows in birdnet data with a matching ARUxhuman file
bn_candidates <- clean_BirdNet_data %>%
  # only rows that have aru_match == "Y" 
  filter(!is.na(aru_match) & aru_match == "Y") %>%
  mutate(
    start_dt  = hm(start_time),
    start_min = hour(start_dt)*60 + minute(start_dt),
    bn_row_id = row_number()   
  )


#Add start_min to PC data and create time tolerance framework for matching with an ARU file. (Within 3 minutes for terrestrial sites. Within 5 minutes for 2 accidental counts added outside of this rule. Within 15 minutes for aquatic sites as those are 20 minute long counts)
pc_candidates <- clean_PC_data %>%
  mutate(
    pc_row_id = row_number(),  # unique ID for each PC row
    start_dt = lubridate::hm(start_time),
    start_min = hour(start_dt) * 60 + minute(start_dt),
    tolerance = case_when(
      site %in% c("L76", "M295") ~ 5,
      site == "U34"              ~ 15,
      str_detect(site, "^[A-Z]{3}$") ~ 15,
      TRUE ~ 3
    )
  )

# Match BirdNet candidates to ARUxHuman anchors 
# inner_join by site+date to avoid a huge full cross-join
bn_matches <- bn_candidates %>%
  inner_join(
    aru_anchors %>% select(site, date, human_start_min = start_min, event_id),
    by = c("site", "date")
  ) %>%
  mutate(time_diff = abs(start_min - human_start_min)) %>%
  filter(time_diff <= 1) %>%            # ±1 minute rule for ARUxBirdNet -> ARUxHuman, should all have the exact same start time so may not be necessary
  group_by(bn_row_id) %>%
  slice_min(time_diff, with_ties = FALSE) %>%  # if multiple anchors, keep closest
  ungroup()


# attach event_id back to the original bn rows, keep only matched ones
birdnet_subset <- bn_candidates %>%
  left_join(bn_matches %>% select(bn_row_id, event_id), by = "bn_row_id") %>%
  filter(!is.na(event_id)) %>%
  select(-bn_row_id)

# Match Point Counts to ARUxHuman anchors 
pc_matches <- pc_candidates %>%
  inner_join(
    aru_anchors %>% select(site, date, human_start_min = start_min, event_id),
    by = c("site", "date")
  ) %>%
  mutate(time_diff = abs(start_min - human_start_min)) %>%
  # keep only where time_diff <= the site's tolerance
  filter(time_diff <= tolerance) %>%
  group_by(pc_row_id) %>%
  slice_min(time_diff, with_ties = FALSE) %>%  
  ungroup()

pc_subset <- pc_candidates %>%
  left_join(pc_matches %>% select(pc_row_id, event_id), by = "pc_row_id") %>%
  filter(!is.na(event_id)) %>%
  select(-pc_row_id, -tolerance)

# Combine all three methods back into one to create full matching subset of data
all_obs_matched <- bind_rows(
  aru_anchors,
  birdnet_subset,
  pc_subset
) %>%
  select(
    site, date, start_time, common_name, species_code, presence, confidence,
    method, pc_match, aru_match, event_id
  ) %>%
  distinct()  

```

1)  Richness - number of species per count between methods
```{r}

## Filtering to counting events with all 3 methods
# pick only events where the ARUxHuman anchor has pc_match == "Y"
events_with_pcY <- aru_anchors %>%
  filter(!is.na(pc_match) & pc_match == "Y") %>%
  pull(event_id) %>%
  unique()

all_obs_PC_matches <- all_obs_matched %>%
  filter(event_id %in% events_with_pcY) %>%
  mutate(
    species_id = coalesce(species_code, common_name) #no species codes for non-birds and birds not in North America from birdnet data so add common name for those
  )

# species richness per counting event for each method (long)
richness_summary <- all_obs_PC_matches %>%
  group_by(site, date, event_id, method) %>%
  summarise(richness = n_distinct(species_id), .groups = "drop")

# wide table
richness_wide <- richness_summary %>%
  pivot_wider(names_from = method,
              values_from = richness,
              values_fill = 0)

#average species richness for each method
avg_richness <- richness_summary %>%
  group_by(method) %>%
  summarise(
    mean_richness = mean(richness),
    sd_val = sd(richness),
    .groups = "drop"
  )

#bar graph of average species richness with standard deviation
ggplot(avg_richness, aes(x = method, y = mean_richness, fill = method)) +
  geom_col(width = 0.6, show.legend = FALSE) +
  geom_errorbar(aes(ymin = mean_richness - sd_val, ymax = mean_richness + sd_val),
                width = 0.2, linewidth = 0.7) +
  labs(
    title = "Average Species Richness by Method (± SD)",
    x = "Method",
    y = "Average Richness"
  ) +
  theme_minimal(base_size = 14)


```
Birdnet has a much lower average number of species detected for any given 10 minute counting segment. This is at the 50% confidence level and is including non-birds (eg frogs, engine nosies, etc) and the full list of worldwide bird species with no filtering. The gap between Birdnet and human counts would only increase if you increased the confidence threshold or filtered out improbable species.

```{r}
#Boxplot of species richness per method
ggplot(richness_summary, aes(x = method, y = richness, fill = method)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.3) +
  labs(
    title = "Distribution of Species Richness per Method",
    x = "Method",
    y = "Richness"
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none")

```


```{r}
#Species counts for each counting event faceted by site for readability.
ggplot(richness_summary, aes(x = event_id, y = richness, fill = method)) +
  geom_col(position = "dodge") +
  facet_wrap(~ site, scales = "free_x") +
  labs(
    title = "Species Richness by Method at Each Count (Faceted by Site)",
    x = "Event ID",
    y = "Richness"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    panel.grid.major.x = element_blank()
  )

```

2. Omission/Comission Analysis

What to do about non-birds/ extremely unlikely birds (eg birds from Asia,Africa,etc) in Birdnet data. Should we filter first before running this analysis?
Should the trusted species list be from all Point Counts and Human Listener files from each site or just the matching ones? Analyze it both ways and compare the two?

Trusted Species List
```{r Trusted Species List Creation}

#Create trusted species list (only from the matched files)
trusted_vectors_matched <- all_obs_PC_matches %>%
  # keep only ARUxHuman and Point Count
  filter(method %in% c("ARUxHuman", "Point Count")) %>%
  # remove duplicates per site + species
  distinct(site, species_id) %>%
  # group by site and make a vector of species
  group_by(site) %>%
  summarise(trusted_species = list(species_id)) %>%
  ungroup()

# define confidence thresholds
confidence_thresholds <- c(0.50, 0.60, 0.70, 0.80, 0.90)

# filter BirdNet detections
birdnet_PC_matches <- all_obs_PC_matches %>%
  filter(method == "ARUxBirdNet")


#Create Birdnet species list vectors for each confidence threshold
birdnet_vectors_matched <- list()

for(thresh in confidence_thresholds) {
  birdnet_vectors_matched[[paste0("conf_", thresh*100)]] <- birdnet_PC_matches %>%
    filter(confidence >= thresh) %>%
    group_by(site) %>%
    summarise(species_list = list(unique(species_id))) %>%
    ungroup()
}

#Compare each confidence threshold with trusted list to create list of trusted species observed by Birdnet at each site
commission_comparison_results <- list()

for(thresh in confidence_thresholds) {
  thresh_name <- paste0("conf_", thresh*100)
  
  commission_comparison_results[[thresh_name]] <- birdnet_vectors_matched[[thresh_name]] %>%
    left_join(trusted_vectors_matched, by = "site") %>%
    rowwise() %>%
    mutate(
      in_trusted = list(intersect(species_list, trusted_species)),
      missing_from_birdnet = list(setdiff(trusted_species, species_list))
    ) %>%
    select(site, species_list, trusted_species, in_trusted, missing_from_birdnet) %>%
    ungroup()
}


# Summary list to show number of trusted species counted, and number of trusted species omitted for each site 
commission_comparison_summary <- list()

for(thresh in confidence_thresholds) {
  thresh_name <- paste0("conf_", thresh*100)
  
  commission_comparison_summary[[thresh_name]] <- commission_comparison_results[[thresh_name]] %>%
    rowwise() %>%
    summarise(
      site = site,
      confidence_threshold = thresh,
      detected_trusted_count = length(in_trusted),
      missing_trusted_count = length(missing_from_birdnet),
      .groups = "drop"
    )
}

# Combine all thresholds into a single table
commission_comparison_summary_table <- bind_rows(commission_comparison_summary) %>%
  arrange(site, confidence_threshold)

#Line graph showing mean trusted species per site obersved by Birdnet at different confidence levels
commission_comparison_summary_table %>%
  group_by(confidence_threshold) %>%
  summarise(mean_detected = mean(detected_trusted_count)) %>%
  ggplot(aes(x = confidence_threshold, y = mean_detected)) +
  geom_line(size = 1.2, color = "steelblue") +
  geom_point(size = 3, color = "steelblue") +
  scale_x_continuous(breaks = confidence_thresholds) +
  labs(
    title = "Mean Trusted Species Detected Across Sites",
    x = "Confidence Threshold",
    y = "Mean Detected Trusted Species"
  ) +
  theme_minimal(base_size = 14)
```

Omission Analysis
```{r Omission Probability}
##Calculating Omission Probability for each method compared to the trusted species list

#Long form of trusted species list for comparison
trusted_species_long <- trusted_vectors_matched %>%
  unnest(trusted_species) %>%          
  rename(species_id = trusted_species) %>%
  distinct(site, species_id)

#Detections for Point Count & ARUxHuman
human_detections <- all_obs_PC_matches %>%
  filter(method %in% c("Point Count", "ARUxHuman"),
         !is.na(species_id)) %>%
  distinct(site, species_id, method)

#Birdnet detections sorted by confidence intervals
birdnet_list <- lapply(confidence_thresholds, function(thresh) {
  all_obs_PC_matches %>%
    filter(method == "ARUxBirdNet",
           !is.na(species_id),
           confidence >= thresh) %>%
    distinct(site, species_id) %>%
    mutate(method = paste0("ARUxBirdnet_", as.integer(thresh*100)))
})

birdnet_detections <- bind_rows(birdnet_list)

# Combine all detections 
all_detections <- bind_rows(human_detections, birdnet_detections)

# omissions_denominatorr for ommission calculation: trusted species per site
omissions_denominator <- trusted_species_long %>%
  group_by(species_id) %>%
  summarise(trusted_sites = n_distinct(site), .groups = "drop")

# Numeratorr for omission calculation: number of trusted sites where each particular method detected each species 
omissions_numerator <- all_detections %>%
  inner_join(trusted_species_long, by = c("site", "species_id")) %>% 
  group_by(species_id, method) %>%
  summarise(detected_trusted_sites = n_distinct(site), .groups = "drop")

# Make sure species-method combos with zero detections appear 
methods_list <- c("Point Count", "ARUxHuman",
                  paste0("ARUxBirdnet_", as.integer(confidence_thresholds*100)))

all_combinations <- expand.grid(
  species_id = omissions_denominator$species_id,
  method = methods_list,
  stringsAsFactors = FALSE
)

#Calculate Omission Probability
#total method detections/total composite detections (from protocol) or 1 - (total method detections/total composite detections)? Should a species that is detected in both methods every time be a 1 or a 0?
omission_prob_full <- all_combinations %>%
  left_join(omissions_numerator, by = c("species_id", "method")) %>%
  left_join(omissions_denominator, by = "species_id") %>%
  mutate(detected_trusted_sites = tidyr::replace_na(detected_trusted_sites, 0),
         omission_probability = 1 - (detected_trusted_sites / trusted_sites)) %>%
  arrange(species_id, method)
```

Species specific Omission Analysis
Looking for species specific trends in omission probability from the most common species.
```{r}
# Top 25 most frequent species in the trusted species list
top25_species <- omissions_denominator %>%
  arrange(desc(trusted_sites)) %>%
  slice_head(n = 25) %>%
  pull(species_id)

# Subset of omission probability results 
omission_top25 <- omission_prob_full %>%
  filter(species_id %in% top25_species)

# Reorder species to put most common on top for nicer plotting
species_order <- omissions_denominator %>%
  filter(species_id %in% top25_species) %>%
  arrange(trusted_sites) %>%
  pull(species_id)

omission_top25$species_id <- factor(omission_top25$species_id,
                                    levels = species_order)

# Heat map of omission probability for 25 most common species for all 3 methods and all 5 Birdnet confidence levels
ggplot(omission_top25,
       aes(x = method, y = species_id, fill = omission_probability)) +
  geom_tile(color = "white") +
  scale_fill_viridis_c(limits = c(0,1), name = "Omission Prob.") +
  labs(
    title = "Omission Probability by Method for 25 Most Common Species",
    x = "Method",
    y = "Species"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid = element_blank())
```
AMRO (American Robin) and WBNU (White-breasted Nuthatch) very often omitted at all confidences. Birdnet seemingly good at detecting RBNU, DUFL, STJA, TOSO. Interesting that TOSO (Townsend's Solitaire) is in same family as AMRO and RBNU (Red-breasted Nuthatch) and PYNU (Pygmy Nuthatch) same family as WBNU. At first glance does not seem that Birdnet consistently misses or accurately accounts for certain groups of birds, looks more species specific. 



```{r}

##Creating line graph of omission probability at difference confidence levels for common species
# Adding confidence thresholds for Birdnet methods
omission_line_data <- omission_top25 %>%
  mutate(
    threshold = ifelse(grepl("Birdnet_", method),
                       as.numeric(sub("ARUxBirdnet_", "", method)) / 100,
                       NA_real_),
    method_type = ifelse(grepl("Birdnet", method),
                         "ARUxBirdnet",
                         method)
  )

# Create a flat line for non-BirdNET methods for comparison
omission_line_data_expanded <- omission_line_data %>%
  filter(!grepl("Birdnet", method)) %>%
  select(-threshold) %>%  
  tidyr::crossing(threshold = confidence_thresholds) %>%
  mutate(method_type = method) %>%
  bind_rows(
    omission_line_data %>% filter(grepl("Birdnet", method))
  )

# Line plot showing change in omission probability over different confidence threshold for the most common species faceted by species
ggplot(omission_line_data_expanded,
       aes(x = threshold, y = omission_probability,
           color = method_type, group = method)) +
  geom_line(size = 1.2, na.rm = TRUE) +
  geom_point(size = 2, na.rm = TRUE) +
  facet_wrap(~ species_id, scales = "free_y", ncol = 5) +
  scale_x_continuous(
    breaks = threshold_levels,
    labels = scales::percent_format(accuracy = 1)
  ) +
  scale_y_continuous(limits = c(0,1)) +
  labs(
    title = "Omission Probability by Species and Method for Most Common Species",
    x = "Confidence Threshold",
    y = "Omission Probability",
    color = "Method"
  ) +
  theme_minimal(base_size = 13) +
  theme(panel.grid.minor = element_blank(),
        strip.text = element_text(face = "bold"))
```
This graph is more readable with only the top 20 or fewer species, but I like the heatmap more with top 25 species.



```{r}
#Creating Line Graph for average omission probability at different Birdnet confidence thresholds for all species that are on the trsuted species list for 3 or more sites
#filter to species in trusted list for >= 3 sites 
species_3plus_sites <- omissions_denominator %>%
  filter(trusted_sites >= 3) %>%
  pull(species_id)

#Calculate average omission probability
birdnet_avg_omission <- omission_prob_full %>%
  filter(species_id %in% species_3plus_sites,
         grepl("Birdnet", method)) %>%
  mutate(
    threshold = as.numeric(sub("ARUxBirdnet_", "", method)) / 100
  ) %>%
  group_by(threshold) %>%
  summarise(avg_omission = mean(omission_probability, na.rm = TRUE),
            .groups = "drop")

# Plot
ggplot(birdnet_avg_omission,
       aes(x = threshold, y = avg_omission)) +
  geom_line(color = "steelblue", size = 1.2) +
  geom_point(color = "steelblue", size = 3) +
  scale_x_continuous(
    breaks = c(0.5, 0.6, 0.7, 0.8, 0.9),
    labels = scales::percent_format(accuracy = 1)
  ) +
  scale_y_continuous(limits = c(0, 1)) +
  labs(
    title = "Average Omission Probability for BirdNet (Species on ≥3 Sites)",
    x = "Confidence Threshold",
    y = "Average Omission Probability"
  ) +
  theme_minimal(base_size = 14)
```

